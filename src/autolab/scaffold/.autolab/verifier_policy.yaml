# =============================================================================
# Autolab Verifier Policy
# =============================================================================
# This file controls verification behavior for each stage transition.
# Customize commands, stage requirements, and runner settings for your project.

# ---------------------------------------------------------------------------
# Tool paths
# ---------------------------------------------------------------------------
python_bin: "python3"

# ---------------------------------------------------------------------------
# Verification commands
# ---------------------------------------------------------------------------
# test_command: invoked when a stage requires tests (see requirements_by_stage).
test_command: "{{python_bin}} -m pytest"

# dry_run_command: invoked when a stage requires dry_run.
# DEFAULT: exits non-zero so that dry-run verification fails until you
# configure a real command.  Replace with your project's smoke-test, e.g.:
#   dry_run_command: "{{python_bin}} -m myproject.dry_run"
dry_run_command: "{{python_bin}} -c \"import sys; print('AUTOLAB DRY-RUN STUB: No dry_run_command configured. Set dry_run_command in .autolab/verifier_policy.yaml or set requirements_by_stage.implementation.dry_run: false to skip.'); sys.exit(1)\""

# ---------------------------------------------------------------------------
# Template-fill verifier
# ---------------------------------------------------------------------------
template_fill:
  enabled: true
  command: "{{python_bin}} .autolab/verifiers/template_fill.py"
  stages:
    hypothesis: true
    design: true
    implementation: true
    implementation_review: true
    launch: true
    extract_results: true
    update_docs: true
    decide_repeat: true

template_fill_by_stage:
  hypothesis: "{{python_bin}} .autolab/verifiers/template_fill.py --stage hypothesis"
  design: "{{python_bin}} .autolab/verifiers/template_fill.py --stage design"
  implementation: "{{python_bin}} .autolab/verifiers/template_fill.py --stage implementation"
  implementation_review: "{{python_bin}} .autolab/verifiers/template_fill.py --stage implementation_review"
  launch: "{{python_bin}} .autolab/verifiers/template_fill.py --stage launch"
  extract_results: "{{python_bin}} .autolab/verifiers/template_fill.py --stage extract_results"
  update_docs: "{{python_bin}} .autolab/verifiers/template_fill.py --stage update_docs"
  decide_repeat: "{{python_bin}} .autolab/verifiers/template_fill.py --stage decide_repeat"

# ---------------------------------------------------------------------------
# Per-stage verification requirements
# ---------------------------------------------------------------------------
# Each key toggles a verification category for that stage.
#   tests            – run test_command
#   dry_run          – run dry_run_command
#   schema           – run schema_checks.py
#   env_smoke        – run run_health.py + result_sanity.py
#   docs_target_update – run docs_targets.py
requirements_by_stage:
  hypothesis:
    tests: false
    dry_run: false
    schema: true
    env_smoke: false
    docs_target_update: false
  design:
    tests: false
    dry_run: false
    schema: true
    env_smoke: false
    docs_target_update: false
  implementation:
    tests: false
    dry_run: true
    schema: true
    env_smoke: false
    docs_target_update: false
  implementation_review:
    tests: false
    dry_run: true
    schema: true
    env_smoke: true
    docs_target_update: true
  launch:
    tests: false
    dry_run: false
    schema: true
    env_smoke: true
    docs_target_update: false
  extract_results:
    tests: false
    dry_run: false
    schema: true
    env_smoke: true
    docs_target_update: false
  update_docs:
    tests: false
    dry_run: false
    schema: true
    env_smoke: false
    docs_target_update: true
  decide_repeat:
    tests: false
    dry_run: false
    schema: true
    env_smoke: false
    docs_target_update: false

# ---------------------------------------------------------------------------
# Implementation plan linter
# ---------------------------------------------------------------------------
implementation_plan_lint:
  enabled: true
  command: "{{python_bin}} .autolab/verifiers/implementation_plan_lint.py"
  stages:
    implementation: true
  scope_enforcement:
    fail_on_out_of_scope_touches: false

# ---------------------------------------------------------------------------
# Schema validation options
# ---------------------------------------------------------------------------
schema_validation:
  # When true, schemas are patched at runtime to set additionalProperties: false
  # on all object definitions, rejecting any unexpected keys.  Default: off.
  strict_additional_properties: true

# ---------------------------------------------------------------------------
# Agent runner configuration
# ---------------------------------------------------------------------------
agent_runner:
  enabled: false
  runner: codex  # Options: codex, claude, custom
  # For claude runner only: set true only in trusted non-interactive automation contexts.
  claude_dangerously_skip_permissions: false
  # command is auto-set from runner preset; override with a custom command to use a specific tool
  stages:
    - hypothesis
    - design
    - implementation
    - implementation_review
    - launch
    - extract_results
    - update_docs
  edit_scope:
    mode: "iteration_plus_core"
    core_dirs:
      - "src"
      - "scripts"
      - ".autolab"
      - "docs"
      - "paper"
      - "tests"
    ensure_iteration_dir: true
  timeout_seconds: 3600

# ---------------------------------------------------------------------------
# Autorun settings (used by `autolab loop --auto`)
# ---------------------------------------------------------------------------
autorun:
  guardrails:
    max_same_decision_streak: 3
    max_no_progress_decisions: 2
    max_update_docs_cycles: 3
    max_generated_todo_tasks: 5
    on_breach: "human_review"

  # Strict-mode toggles for unattended loops.
  # forbid_auto_stop: when true, auto-decision will never select "stop"
  #   without human confirmation — it escalates to human_review instead.
  # require_human_review_for_stop: when true, any "stop" decision in auto
  #   mode is rewritten to "human_review" so a human confirms termination.
  strict_mode:
    forbid_auto_stop: false
    require_human_review_for_stop: false

  auto_commit:
    mode: "meaningful_only"

  meaningful_change:
    require_implementation_progress: true
    require_git_for_progress: true
    on_non_git_behavior: "warn_and_continue"
    require_verification: true
    exclude_paths:
      - ".autolab/**"
      - "docs/todo.md"
      - "docs/wiki/**"
      - "experiments/*/*/docs_update.md"

  todo_fallback:
    local:
      stage: "implementation"
      scope: "policy:no_task_fallback:local"
      text: "No remaining actionable tasks were detected on local execution context. Propose and implement a concrete codebase improvement in src/, scripts/, or experiments/. Prefer the iteration-local implementation subtree (for example `experiments/<type>/<iteration_id>/implementation/`) for experiment-specific changes to avoid unrelated file edits."
    slurm:
      stage: "hypothesis"
      scope: "policy:no_task_fallback:slurm"
      text: "No remaining actionable tasks were detected on remote SLURM execution context. Define a new experiment or analysis direction first, then plan implementation improvements only after that experiment/analysis path is explicit."
