---
# =============================================================================
# Autolab Verifier Policy
# =============================================================================
# This file controls verification behavior for each stage transition.
# Customize commands, stage requirements, and runner settings for your project.
#
# Resolution model:
#   workflow.yaml.verifier_categories = CAPABILITIES (what CAN run)
#   verifier_policy.yaml.requirements_by_stage = REQUIREMENTS (what MUST run)
#   Rule: requirements must be a subset of capabilities
#   Enforced by: registry_consistency.py verifier

# ---------------------------------------------------------------------------
# Tool paths
# ---------------------------------------------------------------------------
python_bin: python3

# ---------------------------------------------------------------------------
# Verification commands
# ---------------------------------------------------------------------------
# test_command: invoked when a stage requires tests (see requirements_by_stage).
test_command: '{{python_bin}} -m pytest'

# dry_run_command: invoked when a stage requires dry_run.
# DEFAULT: Stub that intentionally fails. Replace with a project-specific
# smoke check or set `dry_run: false` in requirements_by_stage.
# Example of a minimal passing dry-run:
#   dry_run_command: "{{python_bin}} -c 'import sys; print(\"dry-run: ok\"); sys.exit(0)'"
dry_run_command: "{{python_bin}} -c \"import sys; print('AUTOLAB DRY-RUN STUB: No dry_run_command configured. Set dry_run_command in .autolab/verifier_policy.yaml or set requirements_by_stage.implementation.dry_run: false to skip.'); sys.exit(1)\""
# ---------------------------------------------------------------------------
# Template-fill verifier
# ---------------------------------------------------------------------------
template_fill:
  enabled: true
  command: '{{python_bin}} .autolab/verifiers/template_fill.py'
  stages:
    hypothesis: true
    design: true
    implementation: true
    implementation_review: true
    launch: true
    slurm_monitor: false
    extract_results: true
    update_docs: true
    decide_repeat: true
template_fill_by_stage:
  hypothesis: '{{python_bin}} .autolab/verifiers/template_fill.py --stage hypothesis'
  design: '{{python_bin}} .autolab/verifiers/template_fill.py --stage design'
  implementation: '{{python_bin}} .autolab/verifiers/template_fill.py --stage implementation'
  implementation_review: '{{python_bin}} .autolab/verifiers/template_fill.py --stage
    implementation_review'
  launch: '{{python_bin}} .autolab/verifiers/template_fill.py --stage launch'
  slurm_monitor: '{{python_bin}} .autolab/verifiers/template_fill.py --stage slurm_monitor'
  extract_results: '{{python_bin}} .autolab/verifiers/template_fill.py --stage extract_results'
  update_docs: '{{python_bin}} .autolab/verifiers/template_fill.py --stage update_docs'
  decide_repeat: '{{python_bin}} .autolab/verifiers/template_fill.py --stage decide_repeat'
# ---------------------------------------------------------------------------
# Per-stage verification requirements
# ---------------------------------------------------------------------------
# Each key toggles a verification category for that stage.
#   tests            – run test_command
#   dry_run          – run dry_run_command
#   schema           – run schema_checks.py
#   prompt_lint      – run prompt_lint.py
#   consistency      – run consistency_checks.py
#   env_smoke        – run run_health.py (all env_smoke stages) and
#                      result_sanity.py only for extract_results
#   docs_target_update – run docs_targets.py
requirements_by_stage:
  hypothesis:  # Early stage: only validate structure and prompts
    tests: false
    dry_run: false
    schema: true
    prompt_lint: true
    consistency: false
    env_smoke: false
    docs_target_update: false
  design:  # Schema validation ensures design.yaml meets spec
    tests: false
    dry_run: false
    schema: true
    prompt_lint: true
    consistency: false
    env_smoke: false
    docs_target_update: false
  implementation:  # Enable dry_run here after configuring dry_run_command above
    tests: false
    dry_run: false
    schema: true
    prompt_lint: true
    consistency: false
    env_smoke: false
    docs_target_update: false
  implementation_review:  # Full verification gate before launch
    tests: false
    dry_run: false
    schema: true
    prompt_lint: true
    consistency: true
    env_smoke: true
    docs_target_update: true
  launch:  # Verify run health and cross-artifact consistency
    tests: false
    dry_run: false
    schema: true
    prompt_lint: true
    consistency: true
    env_smoke: true
    docs_target_update: false
  slurm_monitor:  # Schema/consistency checks on run_manifest.json + prompt lint
    tests: false
    dry_run: false
    schema: true
    prompt_lint: true
    consistency: true
    env_smoke: true
    docs_target_update: false
  extract_results:  # Validate metrics and run artifacts
    tests: false
    dry_run: false
    schema: true
    prompt_lint: true
    consistency: true
    env_smoke: true
    docs_target_update: false
  update_docs:  # Ensure docs match metrics; no env checks needed
    tests: false
    dry_run: false
    schema: true
    prompt_lint: true
    consistency: true
    env_smoke: false
    docs_target_update: true
  decide_repeat:  # Decision stage: validate consistency of evidence
    tests: false
    dry_run: false
    schema: true
    prompt_lint: true
    consistency: true
    env_smoke: false
    docs_target_update: false
# ---------------------------------------------------------------------------
# Implementation plan linter
# ---------------------------------------------------------------------------
implementation_plan_lint:
  enabled: true
  command: '{{python_bin}} .autolab/verifiers/implementation_plan_lint.py'
  stages:
    implementation: true
  scope_enforcement:
    fail_on_out_of_scope_touches: false
# ---------------------------------------------------------------------------
# Schema validation options
# ---------------------------------------------------------------------------
schema_validation:
  # When true, schemas are patched at runtime to set additionalProperties: false
  # on all object definitions, rejecting any unexpected keys.  Default: on.
  strict_additional_properties: true
# ---------------------------------------------------------------------------
# Prompt lint policy
# ---------------------------------------------------------------------------
prompt_lint:
  # warn   -> non-blocking warnings (interactive use only)
  # enforce -> blocking failures
  # Note: auto/runner modes always enforce regardless of this setting.
  mode: warn
  enabled_by_stage:
    hypothesis: true
    design: true
    implementation: true
    implementation_review: true
    launch: true
    slurm_monitor: true
    extract_results: true
    update_docs: true
    decide_repeat: true
# ---------------------------------------------------------------------------
# Launch / SLURM lifecycle controls
# ---------------------------------------------------------------------------
launch:
  # When false, launch stage should generate/validate artifacts without executing
  # local commands or submitting jobs.
  execute: true

slurm:
  # When true, enforce strict lifecycle:
  # slurm_monitor -> status=synced after successful sync
  # extract_results -> finalize run_manifest.status=completed when metrics extraction succeeds
  lifecycle_strict: true
# ---------------------------------------------------------------------------
# Per-stage retry policy
# ---------------------------------------------------------------------------
# Controls how many retries each stage gets before escalating to human_review.
# Falls back to state.max_stage_attempts when a stage is not listed here.
retry_policy_by_stage:
  hypothesis: {max_retries: 3}
  design: {max_retries: 3}
  implementation: {max_retries: 5}
  implementation_review: {max_retries: 5}
  launch: {max_retries: 3}
  slurm_monitor: {max_retries: 3}
  extract_results: {max_retries: 3}
  update_docs: {max_retries: 3}
  decide_repeat: {max_retries: 3}
# ---------------------------------------------------------------------------
# Agent runner configuration
# ---------------------------------------------------------------------------
agent_runner:
  enabled: false
  runner: codex  # Options: codex, claude, custom
  # For claude runner only: set true only in trusted non-interactive automation contexts.
  claude_dangerously_skip_permissions: true
  # For codex runner only: set true only in trusted non-interactive automation
  # contexts where codex sandboxing cannot initialize (e.g. sandbox-exec denies).
  codex_dangerously_bypass_approvals_and_sandbox: true
  # command is auto-set from runner preset; override with a custom command to use a specific tool
  stages:
    - hypothesis
    - design
    - implementation
    - implementation_review
    - launch
    - slurm_monitor
    - extract_results
    - update_docs
  edit_scope:
    mode: iteration_plus_core
    core_dirs: [src, scripts, .autolab, docs, paper, tests]
    ensure_iteration_dir: true
  timeout_seconds: 3600
# ---------------------------------------------------------------------------
# Autorun settings (used by `autolab loop --auto`)
# ---------------------------------------------------------------------------
autorun:
  guardrails:
    max_same_decision_streak: 3
    max_no_progress_decisions: 2
    max_update_docs_cycles: 3
    max_generated_todo_tasks: 5
    on_breach: human_review

  # Strict-mode toggles for unattended loops.
  # forbid_auto_stop: when true, auto-decision will never select "stop"
  #   without human confirmation — it escalates to human_review instead.
  # require_human_review_for_stop: when true, any "stop" decision in auto
  #   mode is rewritten to "human_review" so a human confirms termination.
  strict_mode:
    forbid_auto_stop: false
    require_human_review_for_stop: false
  auto_commit:
    mode: meaningful_only
  meaningful_change:
    require_implementation_progress: true
    require_git_for_progress: true
    on_non_git_behavior: warn_and_continue
    require_verification: true
    exclude_paths:
      - .autolab/**
      - docs/todo.md
      - docs/wiki/**
      - experiments/*/*/docs_update.md
  todo_fallback:
    local:
      stage: implementation
      scope: policy:no_task_fallback:local
      text: No remaining actionable tasks were detected on local execution context.
        Propose and implement a concrete codebase improvement in src/, scripts/, or
        experiments/. Prefer the iteration-local implementation subtree (for example
        `experiments/<type>/<iteration_id>/implementation/`) for experiment-specific
        changes to avoid unrelated file edits.
    slurm:
      stage: hypothesis
      scope: policy:no_task_fallback:slurm
      text: No remaining actionable tasks were detected on remote SLURM execution
        context. Define a new experiment or analysis direction first, then plan implementation
        improvements only after that experiment/analysis path is explicit.
# ---------------------------------------------------------------------------
# Protected files denylist
# ---------------------------------------------------------------------------
# Paths listed here are forbidden from modification by the agent runner.
# If any of these files are changed during a runner execution, the stage
# check will fail immediately.
safe_automation_protected_files: false
protected_file_profiles:
  default: [.autolab/state.json, .autolab/workflow.yaml, .autolab/verifier_policy.yaml]
  safe_automation:
    - .autolab/state.json
    - .autolab/workflow.yaml
    - .autolab/verifier_policy.yaml
    - .autolab/prompts/**
    - .autolab/schemas/**
    - .autolab/verifiers/**
protected_files: [.autolab/state.json, .autolab/workflow.yaml, .autolab/verifier_policy.yaml]
