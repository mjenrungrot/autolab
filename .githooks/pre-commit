#!/usr/bin/env sh
set -eu

repo_root="$(git rev-parse --show-toplevel)"
cd "$repo_root"

default_branch="$(git symbolic-ref --quiet --short refs/remotes/origin/HEAD 2>/dev/null | sed 's#^origin/##')"
if [ -z "$default_branch" ]; then
  default_branch="main"
fi

current_branch="$(git symbolic-ref --quiet --short HEAD 2>/dev/null || true)"
if [ -z "$current_branch" ]; then
  echo "pre-commit: detached HEAD; skipping version bump"
  exit 0
fi
if [ "$current_branch" != "$default_branch" ]; then
  echo "pre-commit: skipping version bump on branch '$current_branch' (default branch: '$default_branch')"
  exit 0
fi

if [ "${AUTOLAB_DISABLE_VERSION_BUMP:-0}" = "1" ]; then
  echo "pre-commit: AUTOLAB_DISABLE_VERSION_BUMP=1; skipping version bump"
  exit 0
fi

if command -v python3 >/dev/null 2>&1; then
  python3 scripts/bump_version.py
elif command -v python >/dev/null 2>&1; then
  python scripts/bump_version.py
else
  echo "pre-commit: ERROR python interpreter not found" >&2
  exit 1
fi

git add pyproject.toml README.md
